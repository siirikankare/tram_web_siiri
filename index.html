<!doctype html> 
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
          <style>
    html, body, #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
    }
	
        </style>
        <title></title>
	    </head>
    <body>
	
        <div id="map">
        </div>
	
		<!-- Palvelulista -->
		<div id="service-list"
		style="position:absolute; top:20px; left:10px; 
                background:rgb(247, 220, 110);; padding:10px; max-height:300px; 
                overflow:auto; z-index:1000; border:1px solid #ccc;">
		</div>

		<!-- Valintapaneeli -->
        <div id="selection-panel"
            style="position:absolute; bottom:25px; right:10px; z-index:1000;
                	background:rgb(247, 220, 110);; border:1px solid #ccc; border-radius:8px;
                    box-shadow:0 2px 8px rgba(0,0,0,0.2); padding:10px; width:220px;">
				
		<!-- Etäisyydenvalinta -->
        <label for="distance-select"
                style="display:block; font-weight:bold; margin-bottom:4px;">
                Select walking distance:
        </label>
        <select id="distance-select"
                style="width:100%; font-size:15px; padding:6px 8px;
                        border-radius:6px; border:1px solid #ccc; margin-bottom:10px;">
            <option value="5min">5 min</option>
            <option value="10min">10 min</option>
            <option value="15min">15 min</option>
        </select>
			
		<!-- Palvelutyypin valinta -->
        <label for="filter-container"
                style="display:block; font-weight:bold; margin-bottom:4px;">
                Select service type:
        </label>
        <select id="filter-container"
                style="width:100%; font-size:15px; padding:6px 8px;
                        border-radius:6px; border:1px solid #ccc;">
            <option value="Kaikki">All services</option>
            <option value="Elokuvateatterit">Cinemas</option>
            <option value="Hostellit">Hostels</option>
            <option value="Hotellit">Hotels</option>
            <option value="Museot">Museums</option>
            <option value="Ravitsemusliikkeet">Restaurants</option>
            <option value="Teatterit">Theatres</option>
			<option value="Kirjastot">Libraries</option>
        </select>
        </div>
			
		
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="data/15MIN_UUSI_1.js"></script>
        <script src="data/10MIN_UUSI_2.js"></script>
        <script src="data/5MIN_UUSI_3.js"></script>
        <script src="data/Rautiotie_4.js"></script>
        <script src="data/PYSAKKI_5.js"></script>
        <script>
		
		var layerGroup5 = L.layerGroup();
		var layerGroup10 = L.layerGroup();
		var layerGroup15 = L.layerGroup();
		
		var currentDistance = "5min"; // oletusarvo
		
		const serviceTranslations = {
		"Ravitsemusliikkeet": "Restaurants",
		"Museot": "Museums",
		"Hotellit": "Hotels",
		"Hostellit": "Hostels",
		"Teatterit": "Theatres",
		"Elokuvateatterit": "Cinemas",
		"Kirjastot": "Libraries",
	};
		
		function showStopServices(stop_id) {
    // Tyhjentää layerit
    layerGroup5.clearLayers();
    layerGroup10.clearLayers();
    layerGroup15.clearLayers();

    // Hakee valitut palvelutyypit
    var typeSelect = document.getElementById("filter-container");
	var selectedType = typeSelect.value;
	var showAll = selectedType === "Kaikki";

    // Ryhmitelty palvelulista 
    var serviceListHTML = "<b>Services:</b><br>";
    var servicesByType = {};

    // Valitaan oikea etäisyyslayer
    var layerToUse;
    if (currentDistance === "5min") layerToUse = layer_5MIN_UUSI_3;
    else if (currentDistance === "10min") layerToUse = layer_10MIN_UUSI_2;
    else if (currentDistance === "15min") layerToUse = layer_15MIN_UUSI_1;

    // Käydään läpi valitun pysäkin palvelut
    layerToUse.eachLayer(function(layer) {
        var p = layer.feature.properties;
        if (p.stop_id == stop_id) {
            var tyyppi = p.palvelukoh;
            var nimi = p.kohteen_ni;
			var englishType = serviceTranslations[tyyppi] || tyyppi;
            if (showAll || tyyppi === selectedType) {
                if (!servicesByType[englishType]) servicesByType[englishType] = [];
                servicesByType[englishType].push(nimi);
            }
        }
    });

	

    // Rakennetaan HTML-lista
    for (var tyyppi in servicesByType) {
        serviceListHTML += "<b>" + tyyppi + "</b><ul>";
        servicesByType[tyyppi].forEach(function(nimi) {
            serviceListHTML += "<li>" + nimi + "</li>";
        });
        serviceListHTML += "</ul>";
    }

    if (Object.keys(servicesByType).length === 0) {
        serviceListHTML += "<i>No selected services in this area.</i>";
    }

    document.getElementById("service-list").innerHTML = serviceListHTML;

    // Päivitetään karttanäyttö
    map.removeLayer(layerGroup5);
    map.removeLayer(layerGroup10);
    map.removeLayer(layerGroup15);

    // Lisätään vain valitut palvelut kartalle
    layer_5MIN_UUSI_3.eachLayer(function(layer) {
    var p = layer.feature.properties;
    if (p.stop_id == stop_id && (showAll || p.palvelukoh === selectedType)) {
        layerGroup5.addLayer(layer);
		}
		});

	layer_10MIN_UUSI_2.eachLayer(function(layer) {
    var p = layer.feature.properties;
    if (p.stop_id == stop_id && (showAll || p.palvelukoh === selectedType)) {
        layerGroup10.addLayer(layer);
    }
	});

	layer_15MIN_UUSI_1.eachLayer(function(layer) {
    var p = layer.feature.properties;
    if (p.stop_id == stop_id && (showAll || p.palvelukoh === selectedType)) {
        layerGroup15.addLayer(layer);
    }
	});

    // Näytetään vain valittu matka-aika
    if (currentDistance === "5min") map.addLayer(layerGroup5);
    else if (currentDistance === "10min") map.addLayer(layerGroup10);
    else if (currentDistance === "15min") map.addLayer(layerGroup15);
	}
	
	
        var map = L.map('map', {
		zoomControl: false,
		maxZoom: 18,
		minZoom: 10
		}).setView([60.4466, 22.3050], 13); // Keskipiste ja zoom-taso

		// Sallittu kartta-alue
		map.setMaxBounds([
		[60.25, 21.60],  
		[60.60, 22.80]   
		]);

		
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
		
        // remove popup's row if "visible-with-data"
	function removeEmptyRowsFromPopupContent(content, feature) {
    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    var rows = tempDiv.querySelectorAll('tr');
    for (var i = 0; i < rows.length; i++) {
        var td = rows[i].querySelector('td.visible-with-data');
        var key = td ? td.id : '';
        var value = feature.properties[key];

        // Tarkista null, undefined tai "null"
        if (value === null || value === undefined || value === "null" || value === "") {
            rows[i].parentNode.removeChild(rows[i]);
        }
    }
    return tempDiv.innerHTML;
}
        
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    // Aggiorna il popup quando il video carica i metadati
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        };
        var abstract = new L.Control({'position':'bottomleft'});
        abstract.onAdd = function (map) {
            this._div = L.DomUtil.create('div',
            'leaflet-control abstract');
            this._div.id = 'abstract'
                this._div.setAttribute("onmouseenter", "abstract.show()");
                this._div.setAttribute("onmouseleave", "abstract.hide()");
                this.hide();
				
				this._div.style.setProperty("background-color", "rgba(247, 220, 110, 0.95)", "important");
				this._div.style.border = "1px solid #ccc";
				this._div.style.borderRadius = "6px";
				this._div.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
				this._div.style.padding = "6px";
				
                return this._div;
            };
            abstract.hide = function () {
                this._div.classList.remove("abstractUncollapsed");
                this._div.classList.add("abstract");
                this._div.innerHTML = 'i'
            }
			abstract.show = function () {
                this._div.classList.remove("abstract");
                this._div.classList.add("abstractUncollapsed");
                this._div.innerHTML = '<br> <b>This interactive web map shows how accessible the services are from the tramstops. You can choose from the dropdown menu on the right if you want to see services within 5-, 10-, or 15-minute walking distance from the chosen tramstop. The walking distances are calculated with 4 kilometers per hour speed. You can also choose if you want to see all services or just hotels or any other kind of services. By clicking any tramstop there will pop-up a list about services around the stop by your selected walking distance. The map will also show you in points where your selected services are. By clicking these points you can get more information about the service.</b> <br /><br />Data Citations: Service point data from Lounaistieto. Available at: https://www.avoindata.fi/data/fi/dataset/varsinais-suomen-ja-satakunnan-palvelupisteet. Digiroads from Finnish Transport Infrastructure Agency. Available at: https://vayla.fi/vaylista/aineistot/digiroad/aineisto/rajapinnat. Tramway and its stops raitiotielinjaus.shp and raitiotielinjaus_pysäkit.shp from Turku city. Available at: https://www.avoindata.fi/data/fi/dataset/turun-raitiotiesuunnitelma. Background map © OpenStreetMap. Available at: https://www.openstreetmap.org. <br/>';
        }
		
		
        abstract.addTo(map);
		abstract.show();

		map.on('click', function() {
            abstract.hide();
        });
        var zoomControl = L.control.zoom({
            position: 'topright'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
		
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '<a href="https://www.openstreetmap.org/">© OpenStreetMap contributors</a>',
            minZoom: 5,
            maxZoom: 18,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.addLayer(layer_OpenStreetMap_0);
		
		// Luo CARTO-kerros
map.createPane('pane_CARTO_0');
map.getPane('pane_CARTO_0').style.zIndex = 399; // taustalle
var layer_CARTO_0 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.carto.com/">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    subdomains: 'abcd',
    maxZoom: 19
});

// OpenStreetMap oletuksena näkyviin
layer_OpenStreetMap_0.addTo(map);
		
		
		
		function zoomToFeature(e) {
    map.flyTo(e.latlng, 16, { duration: 1.5 });
}
		
        function pop_15MIN_UUSI_1(feature, layer) {
    var englishType = serviceTranslations[feature.properties['palvelukoh']] || feature.properties['palvelukoh'];
    
    var popupContent = '<table>\
        <tr>\
            <th scope="row">Service type</th>\
            <td class="visible-with-data" id="palvelukoh">' + (englishType || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Services</th>\
            <td class="visible-with-data" id="palvelut">' + (feature.properties['palvelut'] ? autolinker.link(String(feature.properties['palvelut'])) : '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Name</th>\
            <td class="visible-with-data" id="kohteen_ni">' + (feature.properties['kohteen_ni'] ? autolinker.link(String(feature.properties['kohteen_ni'])) : '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Phone number</th>\
            <td class="visible-with-data" id="puhelinnum">' + (feature.properties['puhelinnum'] ? autolinker.link(String(feature.properties['puhelinnum'])) : '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Address</th>\
            <td class="visible-with-data" id="osoite">' + (feature.properties['osoite'] ? autolinker.link(String(feature.properties['osoite'])) : '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Email</th>\
            <td class="visible-with-data" id="sahkoposti">' + (feature.properties['sahkoposti'] ? autolinker.link(String(feature.properties['sahkoposti'])) : '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Website</th>\
            <td class="visible-with-data" id="verkkosivu">' + (feature.properties['verkkosivu'] ? autolinker.link(String(feature.properties['verkkosivu'])) : '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Opening hours</th>\
            <td class="visible-with-data" id="aukioloaja">' + (feature.properties['aukioloaja'] ? autolinker.link(String(feature.properties['aukioloaja'])) : '') + '</td>\
        </tr>\
    </table>';

    var content = removeEmptyRowsFromPopupContent(popupContent, feature);

    layer.on('popupopen', function(e) {
        addClassToPopupIfMedia(content, e.popup);
    });

    layer.bindPopup(content, { maxWidth: 500, maxHeight: 200 });
}
        function style_15MIN_UUSI_1_0() {
            return {
                pane: 'pane_15MIN_UUSI_1',
                radius: 5.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(1,81,25,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_15MIN_UUSI_1');
        map.getPane('pane_15MIN_UUSI_1').style.zIndex = 401;
        map.getPane('pane_15MIN_UUSI_1').style['mix-blend-mode'] = 'normal';
        var layer_15MIN_UUSI_1 = new L.geoJson(json_15MIN_UUSI_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_15MIN_UUSI_1',
            layerName: 'layer_15MIN_UUSI_1',
            pane: 'pane_15MIN_UUSI_1',
            onEachFeature: pop_15MIN_UUSI_1,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_15MIN_UUSI_1_0(feature));
            },
        });
        bounds_group.addLayer(layer_15MIN_UUSI_1);
        function pop_10MIN_UUSI_2(feature, layer) {
    var englishType = serviceTranslations[feature.properties['palvelukoh']] || feature.properties['palvelukoh'];

    var popupContent = '<table>\
        <tr>\
            <th scope="row">Service type</th>\
            <td class="visible-with-data" id="palvelukoh">' + (englishType || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Services</th>\
            <td class="visible-with-data" id="palvelut">' + (feature.properties['palvelut'] || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Name</th>\
            <td class="visible-with-data" id="kohteen_ni">' + (feature.properties['kohteen_ni'] || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Phone number</th>\
            <td class="visible-with-data" id="puhelinnum">' + (feature.properties['puhelinnum'] || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Address</th>\
            <td class="visible-with-data" id="osoite">' + (feature.properties['osoite'] || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Email</th>\
            <td class="visible-with-data" id="sahkoposti">' + (feature.properties['sahkoposti'] || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Website</th>\
            <td class="visible-with-data" id="verkkosivu">' + (feature.properties['verkkosivu'] || '') + '</td>\
        </tr>\
        <tr>\
            <th scope="row">Opening hours</th>\
            <td class="visible-with-data" id="aukioloaja">' + (feature.properties['aukioloaja'] || '') + '</td>\
        </tr>\
    </table>';

    // Poistaa null-arvot ja tyhjät
    var content = removeEmptyRowsFromPopupContent(popupContent, feature);

    layer.on('popupopen', function(e) {
        addClassToPopupIfMedia(content, e.popup);
    });

    layer.bindPopup(content, { maxWidth: 500, maxHeight: 200 });
}

        function style_10MIN_UUSI_2_0() {
            return {
                pane: 'pane_10MIN_UUSI_2',
                radius: 5.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(147,212,136,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_10MIN_UUSI_2');
        map.getPane('pane_10MIN_UUSI_2').style.zIndex = 402;
        map.getPane('pane_10MIN_UUSI_2').style['mix-blend-mode'] = 'normal';
        var layer_10MIN_UUSI_2 = new L.geoJson(json_10MIN_UUSI_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_10MIN_UUSI_2',
            layerName: 'layer_10MIN_UUSI_2',
            pane: 'pane_10MIN_UUSI_2',
            onEachFeature: pop_10MIN_UUSI_2,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_10MIN_UUSI_2_0(feature));
            },
        });
        bounds_group.addLayer(layer_10MIN_UUSI_2);
        function pop_5MIN_UUSI_3(feature, layer) {
			var englishType = serviceTranslations[feature.properties['palvelukoh']] || feature.properties['palvelukoh'];
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Service type</th>\
                        <td class="visible-with-data" id="palvelukoh">' + englishType + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Services</th>\
                        <td class="visible-with-data" id="palvelut">' + (feature.properties['palvelut'] !== null ? autolinker.link(String(feature.properties['palvelut']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Name</th>\
                        <td class="visible-with-data" id="kohteen_ni">' + (feature.properties['kohteen_ni'] !== null ? autolinker.link(String(feature.properties['kohteen_ni']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Phone number</th>\
                        <td class="visible-with-data" id="puhelinnum">' + (feature.properties['puhelinnum'] !== null ? autolinker.link(String(feature.properties['puhelinnum']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Addres</th>\
                        <td class="visible-with-data" id="osoite">' + (feature.properties['osoite'] !== null ? autolinker.link(String(feature.properties['osoite']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Email</th>\
                        <td class="visible-with-data" id="sahkoposti">' + (feature.properties['sahkoposti'] !== null ? autolinker.link(String(feature.properties['sahkoposti']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Website</th>\
                        <td class="visible-with-data" id="verkkosivu">' + (feature.properties['verkkosivu'] !== null ? autolinker.link(String(feature.properties['verkkosivu']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Opening hours</th>\
                        <td class="visible-with-data" id="aukioloaja">' + (feature.properties['aukioloaja'] !== null ? autolinker.link(String(feature.properties['aukioloaja']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxWidth: 500, maxHeight: 200 });
        }

        function style_5MIN_UUSI_3_0() {
            return {
                pane: 'pane_5MIN_UUSI_3',
                radius: 5.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(247,255,247,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_5MIN_UUSI_3');
        map.getPane('pane_5MIN_UUSI_3').style.zIndex = 403;
        map.getPane('pane_5MIN_UUSI_3').style['mix-blend-mode'] = 'normal';
        var layer_5MIN_UUSI_3 = new L.geoJson(json_5MIN_UUSI_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_5MIN_UUSI_3',
            layerName: 'layer_5MIN_UUSI_3',
            pane: 'pane_5MIN_UUSI_3',
            onEachFeature: pop_5MIN_UUSI_3,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_5MIN_UUSI_3_0(feature));
            },
        });
        bounds_group.addLayer(layer_5MIN_UUSI_3);
        function pop_Rautiotie_4(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['FID'] !== null ? autolinker.link(String(feature.properties['FID']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxWidth: 500, maxHeight: 200 });
        }

        function style_Rautiotie_4_0() {
            return {
                pane: 'pane_Rautiotie_4',
                opacity: 1,
                color: 'rgba(10,0,0,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_Rautiotie_4');
        map.getPane('pane_Rautiotie_4').style.zIndex = 404;
        map.getPane('pane_Rautiotie_4').style['mix-blend-mode'] = 'normal';
        var layer_Rautiotie_4 = new L.geoJson(json_Rautiotie_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Rautiotie_4',
            layerName: 'layer_Rautiotie_4',
            pane: 'pane_Rautiotie_4',
            onEachFeature: pop_Rautiotie_4,
            style: style_Rautiotie_4_0,
        });
        bounds_group.addLayer(layer_Rautiotie_4);
        map.addLayer(layer_Rautiotie_4);
		
		const stopNames = {
		1: "Satama",
		2: "Herttuankulma",
		3: "Vaasanpuisto",
		4: "Kirstinpuisto",
		5: "Rautatieasema",
		6: "Humalistonkatu",
		7: "Eerikinkatu",
		8: "Tuomiokirkkotori",
		9: "Yliopisto",
		10: "Kupittaan asema",
		11: "Joukahaisenkatu",
		12: "Teollisuuskatu",
		13: "Itäharju",
		14: "Voimakatu",
		15: "Laukkavuorenpuisto",
		16: "Fasaaninpuistikko",
		17: "Itäkeskus",
		18: "Karvataskunkatu",
		19: "Talpiankuja",
		20: "Kraatarinkatu"
		};
        function pop_PYSAKKI_5(feature, layer) {
			const id = feature.properties.stop_id;
			const name = stopNames[id] || ("Stop " + id); // jos nimeä ei löydy, näytetään "Stop X"
			layer.bindPopup(name);
			layer.on('click', zoomToFeature);
		}

        function style_PYSAKKI_5_0() {
            return {
                pane: 'pane_PYSAKKI_5',
                radius: 8,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(173,205,111,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_PYSAKKI_5');
        map.getPane('pane_PYSAKKI_5').style.zIndex = 405;
        map.getPane('pane_PYSAKKI_5').style['mix-blend-mode'] = 'normal';
        var layer_PYSAKKI_5 = new L.geoJson(json_PYSAKKI_5, {
            attribution: '',
            interactive: true,
            dataVar: 'json_PYSAKKI_5',
            layerName: 'layer_PYSAKKI_5',
            pane: 'pane_PYSAKKI_5',
            onEachFeature: pop_PYSAKKI_5,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_PYSAKKI_5_0(feature));
            },
        });
        bounds_group.addLayer(layer_PYSAKKI_5);
        map.addLayer(layer_PYSAKKI_5);
        var overlaysTree = [
            {label: '<img src="legend/PYSAKKI_5.png" /> Tram stops', layer: layer_PYSAKKI_5},
            {label: '<img src="legend/Rautiotie_4.png" /> Tram line', layer: layer_Rautiotie_4},
            {label: "OpenStreetMap", layer: layer_OpenStreetMap_0, radioGroup: 'bm' },
			{label: "CARTO Light", layer: layer_CARTO_0, radioGroup: 'bm' }]
        var lay = L.control.layers.tree(null, overlaysTree,{
            //namedToggle: true,
            //selectorBack: false,
            //closedSymbol: '&#8862; &#x1f5c0;',
            //openedSymbol: '&#8863; &#x1f5c1;',
            //collapseAll: 'Collapse all',
            //expandAll: 'Expand all',
            collapsed: true,
        });
		
        lay.addTo(map);
		
		
		var title = new L.Control({position: 'bottomleft'});
title.onAdd = function (map) {
   this._div = L.DomUtil.create('div');
   this._div.style.backgroundColor = 'rgba(247, 220, 110, 0.95)';
   this._div.style.border = '1px solid #ccc';
   this._div.style.borderRadius = '6px';
   this._div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
   this._div.style.padding = '8px';
   this._div.style.color = 'black';
   this._div.style.fontWeight = 'bold';
   this.update();
   return this._div;
};
title.update = function () {
   this._div.innerHTML = '<h2>Turku Tramway Service Area Map</h2><p>Select a tram stop to view nearby services</p>';
};
title.addTo(map);
setBounds();
		
		
		var lastSelectedStopId = null;
		var selectedStopLayer = null;

		layer_PYSAKKI_5.eachLayer(function(layer) {
    layer.on('click', function(e) {
        var stop_id = layer.feature.properties.stop_id;

        // Palauttaa edellisen valitun pysäkin värin
        if (selectedStopLayer && selectedStopLayer !== layer) {
			selectedStopLayer.setStyle({
				color: 'rgba(35,35,35,1.0)',
				fillColor: 'rgba(173,205,111,1.0)'
			});
		}

        // Vaihtaa klikatun pysäkin värin keltaiseksi
        layer.setStyle({
            color: 'rgba(200, 180, 70,1.0)',
            fillColor: 'rgba(247, 220, 110,1.0)'
        });

        selectedStopLayer = layer; // Päivittää valitun layerin
        lastSelectedStopId = stop_id;

        // Avaa popup ja päivittää palvelulistan
        layer.openPopup();
        showStopServices(stop_id);
		});
		});

// --- Pudotusvalikon muutos päivittää näkyvät palvelut ---
		document.getElementById("distance-select").addEventListener("change", function(e) {
		currentDistance = e.target.value;
		if (lastSelectedStopId !== null) {
        showStopServices(lastSelectedStopId);
		}
		});
		
		document.getElementById("filter-container").addEventListener("change", function() {
    if (lastSelectedStopId !== null) {
        showStopServices(lastSelectedStopId);
    }
});;	
        </script>        
    </body>
</html>
